<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-04-07 mer. 10:38 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reproducing Spectre Attack with gem5, How To Do It Right?</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Pierre Ayoub" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="https://sandyuraz.com/styles/org.min.css">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Reproducing Spectre Attack with gem5, How To Do It Right?</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org65a11dc">1. Introduction</a></li>
<li><a href="#org5650048">2. Repository</a></li>
<li><a href="#org72cb97e">3. HowTo</a>
<ul>
<li><a href="#setup_arm">3.1. How to Setup the Native ARM System</a></li>
<li><a href="#howto_spectre">3.2. How to Perform the Spectre Attack</a></li>
<li><a href="#howto_gem5_setup">3.3. How to Setup gem5 for a Full-System Simulation</a></li>
<li><a href="#howto_gem5">3.4. How to Simulate Spectre with gem5</a></li>
<li><a href="#howto_konata">3.5. How to Visualize the Pipeline of a gem5 Processor with Konata</a></li>
</ul>
</li>
<li><a href="#org1041c95">4. Implementations</a>
<ul>
<li><a href="#implem_spectre">4.1. Spectre</a></li>
<li><a href="#implem_gem5">4.2. gem5</a></li>
</ul>
</li>
<li><a href="#org166628e">5. Appendices</a></li>
</ul>
</div>
</div>

<div id="outline-container-org65a11dc" class="outline-2">
<h2 id="org65a11dc"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This web page is linked to the <i><a href="https://github.com/pierreay/reproduce-spectre-gem5/blob/main/docs/paper.pdf">Reproducing Spectre Attack with gem5, How To
Do It Right?</a></i> paper, as well with the <i><a href="https://github.com/pierreay/reproduce-spectre-gem5/blob/main/docs/master_thesis.pdf">Simulating Transient Execution Attacks
with gem5</a></i> master thesis.
</p>

<p>
It will guide you through the reproduction of the experiments, the usage of
our implementations or through the demonstration of some techniques discussed
in the paper. You can navigate with the table of content, or directly click
below to:
</p>
<ul class="org-ul">
<li><a href="#howto_spectre">Learn how to perform a Spectre attack with our implementation</a></li>
<li><a href="#howto_spectre">Learn how to simulate Spectre with gem5</a></li>
<li><a href="#howto_konata">Learn how to visualize the pipeline of a simulated processor with Konata</a></li>
</ul>
</div>
</div>

<div id="outline-container-org5650048" class="outline-2">
<h2 id="org5650048"><span class="section-number-2">2</span> Repository</h2>
<div class="outline-text-2" id="text-2">
<p>
This web page is part of the repository located <a href="https://github.com/pierreay/reproduce-spectre-gem5">here</a>. See the <code>README.md</code>
file for repository organization and navigation.
</p>
</div>
</div>

<div id="outline-container-org72cb97e" class="outline-2">
<h2 id="org72cb97e"><span class="section-number-2">3</span> HowTo</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-setup_arm" class="outline-3">
<h3 id="setup_arm"><span class="section-number-3">3.1</span> How to Setup the Native ARM System</h3>
<div class="outline-text-3" id="text-setup_arm">
<p>
To reproduce this work, you will need:
</p>
<ul class="org-ul">
<li>An ARM board. We used a <a href="https://static.raspberrypi.org/files/product-briefs/200521+Raspberry+Pi+4+Product+Brief.pdf">Raspberry Pi v4 Model B Rev 1.1</a> embedding a <a href="http://infocenter.arm.com/help/topic/com.arm.doc.100095_0003_06_en/cortex_a72_mpcore_trm_100095_0003_06_en.pdf">ARM
Cortex-A72</a> (ARMv8-A) processor implemented in a SoC <a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2711/rpi_DATA_2711_1p0.pdf">Broadcom BCM2711</a>.</li>
<li>A 64-bit operating system (kernel and userland) for ARM. We used <a href="https://www.offensive-security.com/kali-linux-arm-images/">Kali
Linux</a> (stable v2020.2a, with a Linux kernel v4.19.118-Re4son-v8l+ and a
GCC compiler v9.3), because:
<ol class="org-ol">
<li>It is a full 64-bit operating system supporting ARM,</li>
<li>The kernel is nearly the same as the one provided by gem5,</li>
<li>The kernel sources and headers are available with <code>apt</code> (for developing
kernel modules, if you do so).</li>
</ol></li>
</ul>

<p>
Install the Kali Linux distribution. First, download the image:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> /tmp
<span style="color: #47ba99;">zip</span>=<span style="color: #fbaed2;">"kali.xz"</span>
<span style="color: #47ba99;">img</span>=<span style="color: #fbaed2;">"kali.img"</span>
wget -O <span style="color: #fbaed2;">"$zip"</span> https://images.offensive-security.com/arm-images/kali-linux-2020.2a-rpi3-nexmon-64.img.xz
xzcat <span style="color: #fbaed2;">"$zip"</span> &gt; <span style="color: #fbaed2;">"$img"</span>
rm -f <span style="color: #fbaed2;">"$zip"</span>
</pre>
</div>

<p>
Then, insert your SD card in your computer, and make sure that device block
name is correct (find it with <code>lsblk</code> and <code>umount</code> it if it has been
automatically mounted). Bit-copy the image on the SD card:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">sdcard</span>=/dev/sdd
sudo dd <span style="color: #47ba99;">bs</span>=<span style="color: #ef6787;">4M</span> <span style="color: #47ba99;">if</span>=<span style="color: #fbaed2;">"$img"</span> <span style="color: #47ba99;">of</span>=<span style="color: #fbaed2;">"$sdcard"</span> <span style="color: #47ba99;">status</span>=progress <span style="color: #47ba99;">conv</span>=fsync
rm -f <span style="color: #fbaed2;">"$img"</span>
</pre>
</div>

<p>
Now, plug the SD card in the Raspberry Pi, plug an Ethernet cable and plug
the power cable in it. Then, find the IP address associated to it and
connect with the <code>kali</code> login and <code>kali</code> password:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">ip</span>=<span style="color: #fbaed2;">"192.168.1.1"</span> <span style="color: #697375;"># </span><span style="color: #697375;">Find the correct IP.</span>
ssh kali@$<span style="color: #47ba99;">ip</span>
<span style="color: #697375;"># </span><span style="color: #697375;">We install the following software:</span>
sudo apt-get update &amp;&amp; sudo apt-get upgrade
sudo apt-get -y install linux-cpupower git
</pre>
</div>

<p>
You can log in the <code>root</code> account by issuing the command <code>sudo su root</code> if
needed.
</p>

<p>
You are now ready to reproduce Spectre on the Raspberry Pi.
</p>
</div>
</div>

<div id="outline-container-howto_spectre" class="outline-3">
<h3 id="howto_spectre"><span class="section-number-3">3.2</span> How to Perform the Spectre Attack</h3>
<div class="outline-text-3" id="text-howto_spectre">
<p>
We assume that you are on the ARM system described in Section <a href="#setup_arm">3.1</a> or
an equivalent one.
</p>

<p>
First, clone the repository:
</p>

<div class="org-src-container">
<pre class="src src-bash">git clone https://github.com/pierreay/reproduce-spectre-gem5
<span style="color: #697375;"># </span><span style="color: #697375;">We will use this variable to designate the repository through the hole file.</span>
<span style="color: #47ba99;">reproducing_repo</span>=<span style="color: #fbaed2;">"$(pwd)/reproduce-spectre-gem5"</span>
<span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$reproducing_repo"</span>
</pre>
</div>

<p>
Simply use the <code>Makefile</code> to compile our implementation, described in
Section <a href="#implem_spectre">4.1</a>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> spectre &amp;&amp; make
</pre>
</div>

<p>
Test if the binary is working by displaying a useful help message:
</p>

<div class="org-src-container">
<pre class="src src-bash">./spectre --help
</pre>
</div>

<pre class="example" id="orga9c14e6">
Usage: spectre [OPTION...]
Spectre -- A Spectre implementation useful for research

  -c, --cache_threshold=NUMBER   Cache threshold separating hit and miss
                             (default: automatically computed)
  -l, --loops=NUMBER         Number of loops (training and attack) per attempts
                             (default: 30)
  -m, --meta=NUMBER          Number of meta-repetition of Spectre (default: 1)
  -q, -s, --quiet, --silent  Don't produce the header for csv
  -t, --tries=NUMBER         Number of attempts to guess a secret byte
                             (default: 999)
  -v, --verbose              Produce verbose output
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version

Mandatory or optional arguments to long options are also mandatory or optional
for any corresponding short options.

Report bugs to &lt;pierre.ayoub@irisa.fr&gt;.
</pre>

<p>
And test the attack with the default parameters like this:
</p>

<div class="org-src-container">
<pre class="src src-bash">./spectre 
</pre>
</div>

<p>
If it works correctly, you surely want to generate the metrics as we do in
the paper and customize some parameters. The metrics will be generated in a
<code>csv</code> format, you can then redirect them to a file. To do so, we use this
loop to repeat the hole experiment. We first launch one experiment, and
relaunch the others with the <code>-q</code> flag to suppress header line:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #697375;"># </span><span style="color: #697375;">Parameters.</span>
<span style="color: #47ba99;">runs</span>=<span style="color: #ef6787;">50</span> <span style="color: #697375;"># </span><span style="color: #697375;">Number of runs - 1.</span>
<span style="color: #47ba99;">m</span>=<span style="color: #ef6787;">10</span>    <span style="color: #697375;"># </span><span style="color: #697375;">Number of meta repetition in the binary itself.</span>
<span style="color: #47ba99;">t</span>=<span style="color: #ef6787;">999</span>   <span style="color: #697375;"># </span><span style="color: #697375;">Number of attempts to guess one byte.</span>
<span style="color: #47ba99;">l</span>=<span style="color: #ef6787;">100</span>   <span style="color: #697375;"># </span><span style="color: #697375;">Number of loop per attempt.</span>
<span style="color: #697375;"># </span><span style="color: #697375;">Runs.</span>
./spectre/spectre -m $<span style="color: #47ba99;">m</span> -l $<span style="color: #47ba99;">l</span> -t $<span style="color: #47ba99;">t</span>
<span style="color: #4EB8CA;">for</span> <span style="color: #4EB8CA;">(</span><span style="color: #91b9c7;">(</span> <span style="color: #47ba99;">i</span> = <span style="color: #ef6787;">1</span>; i &lt; $<span style="color: #47ba99;">runs</span>; i++ <span style="color: #91b9c7;">)</span><span style="color: #4EB8CA;">)</span>
<span style="color: #4EB8CA;">do</span>  
    ./spectre/spectre -q -m $<span style="color: #47ba99;">m</span> -l $<span style="color: #47ba99;">l</span> -t $<span style="color: #47ba99;">t</span>   
<span style="color: #4EB8CA;">done</span>
</pre>
</div>

<p>
<b>Optional</b>. If you want to obtain the <code>perf_event</code> metrics under a gem5
simulation, you will have to recompile the Spectre binary with a patch. This
is still a <code>TODO</code> item in the source code. To do that, use <code>git-apply</code> to
apply the patch, save the previously compiled binary with another name and
relaunch <code>make</code>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #697375;"># </span><span style="color: #697375;">Apply the patch</span>
<span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$reproduce_repo"</span>
git apply spectre/perf.c.patch
<span style="color: #697375;"># </span><span style="color: #697375;">Save the previous binary</span>
<span style="color: #91b9c7;">cd</span> spectre
mv spectre spectre_native
<span style="color: #697375;"># </span><span style="color: #697375;">Compile the new Spectre</span>
make
</pre>
</div>
</div>
</div>

<div id="outline-container-howto_gem5_setup" class="outline-3">
<h3 id="howto_gem5_setup"><span class="section-number-3">3.3</span> How to Setup gem5 for a Full-System Simulation</h3>
<div class="outline-text-3" id="text-howto_gem5_setup">
<p>
To reproduce this work, you will need:
</p>
<ul class="org-ul">
<li>A working <a href="https://www.gem5.org/getting_started/">gem5</a> installation. We used gem5 v20.0.</li>
<li>An <a href="https://www.gem5.org/documentation/general_docs/fullsystem/guest_binaries">operating system image and a kernel image</a> ready-to-use with gem5. We
used the <a href="http://dist.gem5.org/dist/current/arm/disks/linaro-minimal-aarch64.img.bz2">64-bit Linaro Minimal v7.4.0 (based on Ubuntu)</a> and the <a href="http://dist.gem5.org/dist/current/arm/aarch-system-201901106.tar.bz2">ARM64
Linux kernel v4.18.0</a> images provided by gem5's developers.</li>
</ul>

<p>
Note that this gem5 version and the images are now obsolete. You can of
course follow our steps, but then for a new research, it would be better to
use the latest gem5 version and images with the new recommended methods
(e.g., Docker container).
</p>

<p>
First, install the recommended packages:
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo apt install build-essential git m4 scons zlib1g zlib1g-dev <span style="color: #fbaed2;">\</span>
    libprotobuf-dev protobuf-compiler libprotoc-dev libgoogle-perftools-dev <span style="color: #fbaed2;">\</span>
    python3-dev python3-six python libboost-all-dev pkg-config
</pre>
</div>

<p>
Clone the gem5 repository:
</p>

<div class="org-src-container">
<pre class="src src-bash">git clone https://gem5.googlesource.com/public/gem5
<span style="color: #697375;"># </span><span style="color: #697375;">We will use this variable to designate the gem5 repository through the hole</span>
<span style="color: #697375;"># </span><span style="color: #697375;">file.</span>
<span style="color: #47ba99;">gem5_repo</span>=<span style="color: #fbaed2;">"$(pwd)/gem5"</span>
<span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$gem5_repo"</span>
</pre>
</div>

<p>
Checkout the commit for version 20.0:
</p>

<div class="org-src-container">
<pre class="src src-bash">git checkout v20.0.0.0
</pre>
</div>

<p>
<b>Optional</b>. If you want to obtain the <code>perf_event</code> metrics under a gem5
simulation, you will have to apply a patch from our repository to the gem5
source code to enable <code>perf_event</code> on the gem5 side (note that it should not
be required on the latest gem5 version). To do that, use:
</p>

<div class="org-src-container">
<pre class="src src-bash">git apply <span style="color: #fbaed2;">"$reproduce_repo/gem5/perf_event.patch"</span>
</pre>
</div>

<p>
And finally, compile it in optimized mode (<code>opt</code>), for the ARM architecture
(<code>ARM</code>), with 8 cores and for Python 3. It can take several hours:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">mode</span>=<span style="color: #fbaed2;">"opt"</span>
<span style="color: #47ba99;">arch</span>=<span style="color: #fbaed2;">"ARM"</span>
<span style="color: #47ba99;">cores</span>=<span style="color: #ef6787;">8</span>
<span style="color: #47ba99;">py_version</span>=<span style="color: #ef6787;">3</span> 
scons <span style="color: #47ba99;">PYTHON_CONFIG</span>=python$<span style="color: #47ba99;">py_version</span>-config build/$<span style="color: #47ba99;">arch</span>/gem5.$<span style="color: #47ba99;">mode</span> -j $<span style="color: #47ba99;">cores</span>
</pre>
</div>

<p>
If everything is working, you should be able to display the help of one
simulation script:
</p>

<div class="org-src-container">
<pre class="src src-bash">build/ARM/gem5.opt -q configs/example/arm/starter_fs.py --help   
</pre>
</div>

<p>
Otherwise, check the <a href="https://pierreay.github.io/reproduce-spectre-gem5/gem5_errors.html#compilation"><code>docs/gem5_errors.html</code></a> file to see if the compilation
error has already been encountered.
</p>

<p>
Let's create the images you need to perform a full-system
simulation. First, you have to download the operating system and the kernel
images that you will use over our simulated hardware:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">img_dir</span>=img
mkdir $<span style="color: #47ba99;">img_dir</span> &amp;&amp; <span style="color: #91b9c7;">cd</span> $<span style="color: #47ba99;">img_dir</span>
<span style="color: #697375;"># </span><span style="color: #697375;">OS</span>
wget -O - http://dist.gem5.org/dist/current/arm/disks/linaro-minimal-aarch64.img.bz2 | bunzip2 &gt; linaro-minimal-aarch64.img
<span style="color: #697375;"># </span><span style="color: #697375;">Kernel</span>
wget -O - http://dist.gem5.org/dist/current/arm/aarch-system-201901106.tar.bz2 | tar xjv
</pre>
</div>

<p>
Then, you will have to create a third <code>workload.img</code> image that will
contain the file(s) that you want to use in your experiments. In order to
do that, first create a 100MB zero file (you can change the size with the
<code>count</code> parameter):
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">img</span>=workload.img
dd <span style="color: #47ba99;">if</span>=/dev/zero <span style="color: #47ba99;">of</span>=$<span style="color: #47ba99;">img</span> <span style="color: #47ba99;">count</span>=<span style="color: #ef6787;">200K</span>
</pre>
</div>

<p>
Create a loopback device in order to access the image as a block device:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">dev</span>=$<span style="color: #4EB8CA;">(</span>sudo losetup -f<span style="color: #4EB8CA;">)</span>
sudo losetup -fP $<span style="color: #47ba99;">img</span>
</pre>
</div>

<p>
Create a DOS partition table and a primary partition on the entire image,
then format the new created partition with the <code>ext4</code> file system:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">echo</span> <span style="color: #fbaed2;">","</span> | sudo sfdisk $<span style="color: #47ba99;">dev</span>
sudo mke2fs <span style="color: #fbaed2;">"$dev"</span>p1
</pre>
</div>

<p>
Finally, you are done at modifying your image, detach it from the loopback
device:
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo losetup -d $<span style="color: #47ba99;">dev</span>
</pre>
</div>

<p>
Now, you have a persistent file that will hold your files for the
simulation. Define a function that will be used each time you need to
update the image with new files (binaries, data&#x2026;):
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #697375;"># </span><span style="color: #697375;">$1: workload image name/path.</span>
<span style="color: #697375;"># </span><span style="color: #697375;">$*: list of files to copy.</span>
<span style="color: #91b9c7;">workload_update</span><span style="color: #4EB8CA;">()</span> <span style="color: #4EB8CA;">{</span>
    <span style="color: #47ba99;">dev</span>=$<span style="color: #91b9c7;">(</span>sudo losetup -f<span style="color: #91b9c7;">)</span>
    <span style="color: #47ba99;">mnt</span>=/mnt/workload
    <span style="color: #697375;"># </span><span style="color: #697375;">Get arguments.</span>
    <span style="color: #47ba99;">img</span>=<span style="color: #fbaed2;">"$1"</span>
    <span style="color: #91b9c7;">shift</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Create the mount folder and the loop device.</span>
    sudo mkdir -p $<span style="color: #47ba99;">mnt</span>
    sudo losetup -fP <span style="color: #fbaed2;">"$img"</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Mount the block device.</span>
    sudo mount -o loop $<span style="color: #47ba99;">dev</span> $<span style="color: #47ba99;">mnt</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Copy files/folders.</span>
    sudo cp -r -f -t $<span style="color: #47ba99;">mnt</span> $<span style="color: #47ba99;">*</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">List the files to confirm.</span>
    ls -alh $<span style="color: #47ba99;">mnt</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Unmount the image and freed the loop device.</span>
    sudo umount $<span style="color: #47ba99;">mnt</span>
    sudo losetup -d $<span style="color: #47ba99;">dev</span>
<span style="color: #4EB8CA;">}</span>
</pre>
</div>

<p>
We will use this function later. All your 3 images will be mounted directly
in the simulated system by gem5 itself, and the files in the workload image
will be accessible in read/write. This is an efficient and handy way to
communicate with a gem5 simulation.
</p>
</div>
</div>

<div id="outline-container-howto_gem5" class="outline-3">
<h3 id="howto_gem5"><span class="section-number-3">3.4</span> How to Simulate Spectre with gem5</h3>
<div class="outline-text-3" id="text-howto_gem5">
<p>
We assume that you are able to compile and know how to perform a Spectre
attack with our binary (at least in theory), described in Section
<a href="#howto_spectre">3.2</a>.
</p>

<p>
We assume that your gem5 setup is ready to perform a full-system simulation,
described in Section <a href="#howto_gem5_setup">3.3</a>.
</p>

<p>
The first step is to copy the Spectre binary on the <code>workload.img</code>
image. Use our predefined function for that:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$reproduce_repo"</span>
workload_update <span style="color: #fbaed2;">"$gem5_repo/$img_dir/$img"</span> spectre/spectre
</pre>
</div>

<p>
Then, we will launch the simulation of our system, described in Section
<a href="#implem_gem5">4.2</a>, with gem5:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> gem5
</pre>
</div>
</div>
</div>

<div id="outline-container-howto_konata" class="outline-3">
<h3 id="howto_konata"><span class="section-number-3">3.5</span> How to Visualize the Pipeline of a gem5 Processor with Konata</h3>
<div class="outline-text-3" id="text-howto_konata">
</div>
</div>
</div>

<div id="outline-container-org1041c95" class="outline-2">
<h2 id="org1041c95"><span class="section-number-2">4</span> Implementations</h2>
<div class="outline-text-2" id="text-4">
<p>
Implementation details goes here.
</p>
</div>

<div id="outline-container-implem_spectre" class="outline-3">
<h3 id="implem_spectre"><span class="section-number-3">4.1</span> Spectre</h3>
<div class="outline-text-3" id="text-implem_spectre">
<p>
Our implementation resides in the <code>spectre</code> directory of the repository:
</p>

<pre class="example" id="org73a7443">
spectre
├── asm.c
├── asm.h
├── main.c
├── Makefile
├── perf.c
├── perf.h
├── spectre_pht_sa_ip.c
├── spectre_pht_sa_ip.h
├── util.c
└── util.h

0 directories, 10 files
</pre>

<p>
It is composed of the following modules:
</p>
<dl class="org-dl">
<dt><code>asm</code></dt><dd>ARM assembly implementation.</dd>
<dt><code>main</code></dt><dd>Orchestrate all the modules.</dd>
<dt><code>perf</code></dt><dd><code>perf_event</code> wrapper.</dd>
<dt><code>spectre_pht_sa_ip</code></dt><dd>Spectre implementation (for the PHT-SA-IP
version).</dd>
<dt>util</dt><dd>Useful functions used across the binary.</dd>
</dl>

<p>
Note that:
</p>
<ul class="org-ul">
<li>There is a lot of comments into the code, don't hesitate to look at it to
understands specific parts of the Spectre attack or the assembly
instructions.</li>
</ul>
</div>
</div>

<div id="outline-container-implem_gem5" class="outline-3">
<h3 id="implem_gem5"><span class="section-number-3">4.2</span> gem5</h3>
<div class="outline-text-3" id="text-implem_gem5">
<p>
To understand what the patch does and how it works, see our corresponding
<a href="https://stackoverflow.com/questions/63988672/using-perf-event-with-the-arm-pmu-inside-gem5">StackOverflow post</a> or our <a href="https://www.mail-archive.com/gem5-users@gem5.org/msg18401.html">ticket on the gem5 mailing list</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org166628e" class="outline-2">
<h2 id="org166628e"><span class="section-number-2">5</span> Appendices</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>If you are a gem5 user who experience some unresolved errors, you could
check the <a href="https://pierreay.github.io/reproduce-spectre-gem5/gem5_errors.html#runtime"><code>docs/gem5_errors.html</code></a> file.</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Pierre Ayoub</p>
<p class="date">Created: 2021-04-07 mer. 10:38</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
