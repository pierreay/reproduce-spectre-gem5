<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-03-31 mer. 12:41 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reproducing Spectre Attack with gem5, How To Do It Right?</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Pierre Ayoub" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="https://sandyuraz.com/styles/org.min.css">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Reproducing Spectre Attack with gem5, How To Do It Right?</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgea7a094">1. Introduction</a></li>
<li><a href="#orga9726a1">2. Repository</a></li>
<li><a href="#orgba0d3e3">3. HowTo</a>
<ul>
<li><a href="#howto_spectre">3.1. How to Perform the Spectre Attack</a></li>
<li><a href="#howto_gem5">3.2. How to Simulate Spectre with gem5</a></li>
<li><a href="#howto_konata">3.3. How to Visualize the Pipeline of a gem5 Processor with Konata</a></li>
</ul>
</li>
<li><a href="#org9419b5c">4. Implementations</a>
<ul>
<li><a href="#orgc29b5d5">4.1. Spectre</a></li>
<li><a href="#org9fd6e57">4.2. gem5</a></li>
</ul>
</li>
<li><a href="#org0de5527">5. Appendices</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgea7a094" class="outline-2">
<h2 id="orgea7a094"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This web page is linked to the <i><a href="https://github.com/pierreay/reproduce-spectre-gem5/blob/main/docs/paper.pdf">Reproducing Spectre Attack with gem5, How To
Do It Right?</a></i> paper, as well with the <i><a href="https://github.com/pierreay/reproduce-spectre-gem5/blob/main/docs/report.pdf">Simulating Transient Execution Attacks
with gem5</a></i> master thesis.
</p>

<p>
It will guide you through the reproduction of the experiments, the usage of
our implementations or through the demonstration of some techniques discussed
in the paper. You can navigate with the table of content, or directly click
below to:
</p>
<ul class="org-ul">
<li><a href="#howto_spectre">Learn how to perform a Spectre attack with our implementation</a></li>
<li><a href="#howto_spectre">Learn how to simulate Spectre with gem5</a></li>
<li><a href="#howto_konata">Learn how to visualize the pipeline of a simulated processor with Konata</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga9726a1" class="outline-2">
<h2 id="orga9726a1"><span class="section-number-2">2</span> Repository</h2>
<div class="outline-text-2" id="text-2">
<p>
This web page is part of the repository located <a href="https://github.com/pierreay/reproduce-spectre-gem5">here</a>. See the <code>README.md</code>
file for repository organization and navigation.
</p>
</div>
</div>

<div id="outline-container-orgba0d3e3" class="outline-2">
<h2 id="orgba0d3e3"><span class="section-number-2">3</span> HowTo</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-howto_spectre" class="outline-3">
<h3 id="howto_spectre"><span class="section-number-3">3.1</span> How to Perform the Spectre Attack</h3>
<div class="outline-text-3" id="text-howto_spectre">
<p>
We assume that you cloned the repository on an ARM system, like a Raspberry
Pi.
</p>

<p>
Simply use the <code>Makefile</code> to compile our implementation:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> spectre
make
</pre>
</div>

<p>
Test if the binary is working by displaying an useful help message:
</p>

<div class="org-src-container">
<pre class="src src-bash">./spectre --help
</pre>
</div>

<pre class="example" id="orge992b43">
Usage: spectre [OPTION...]
Spectre -- A Spectre implementation useful for research

  -c, --cache_threshold=NUMBER   Cache threshold separating hit and miss
                             (default: automatically computed)
  -l, --loops=NUMBER         Number of loops (training and attack) per attempts
                             (default: 30)
  -m, --meta=NUMBER          Number of meta-repetition of Spectre (default: 1)
  -q, -s, --quiet, --silent  Don't produce the header for csv
  -t, --tries=NUMBER         Number of attempts to guess a secret byte
                             (default: 999)
  -v, --verbose              Produce verbose output
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version

Mandatory or optional arguments to long options are also mandatory or optional
for any corresponding short options.

Report bugs to &lt;pierre.ayoub@irisa.fr&gt;.
</pre>

<p>
And test the attack with default parameters like this:
</p>

<div class="org-src-container">
<pre class="src src-bash">./spectre 
</pre>
</div>

<p>
If it works correctly, you surely want to generate the metrics as we do in
the paper and customize some parameters. To do so, we use this loop for
repeating runs. We first launch one experiment, and relaunch the others
with the <code>-q</code> flag to suppress header line:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #697375;"># </span><span style="color: #697375;">Parameters.</span>
<span style="color: #47ba99;">runs</span>=<span style="color: #ef6787;">50</span> <span style="color: #697375;"># </span><span style="color: #697375;">Number of runs - 1.</span>
<span style="color: #47ba99;">m</span>=<span style="color: #ef6787;">10</span>    <span style="color: #697375;"># </span><span style="color: #697375;">Number of meta repetition in the binary itself.</span>
<span style="color: #47ba99;">t</span>=<span style="color: #ef6787;">999</span>   <span style="color: #697375;"># </span><span style="color: #697375;">Number of attempts to guess one byte.</span>
<span style="color: #47ba99;">l</span>=<span style="color: #ef6787;">100</span>   <span style="color: #697375;"># </span><span style="color: #697375;">Number of loop per attempt.</span>
<span style="color: #697375;"># </span><span style="color: #697375;">Runs.</span>
./spectre/spectre -m $<span style="color: #47ba99;">m</span> -l $<span style="color: #47ba99;">l</span> -t $<span style="color: #47ba99;">t</span>
<span style="color: #4EB8CA;">for</span> <span style="color: #4EB8CA;">(</span><span style="color: #91b9c7;">(</span> <span style="color: #47ba99;">i</span> = <span style="color: #ef6787;">1</span>; i &lt; $<span style="color: #47ba99;">runs</span>; i++ <span style="color: #91b9c7;">)</span><span style="color: #4EB8CA;">)</span>
<span style="color: #4EB8CA;">do</span>  
    ./spectre/spectre -q -m $<span style="color: #47ba99;">m</span> -l $<span style="color: #47ba99;">l</span> -t $<span style="color: #47ba99;">t</span>   
<span style="color: #4EB8CA;">done</span>
</pre>
</div>

<p>
Important note:
</p>
<ul class="org-ul">
<li>There is a <code>TODO</code> item in the <code>perf.c</code> file that requires a manual
intervention to use <code>perf_event</code> either on a native ARM system or on a
gem5's simulated ARM system.</li>
</ul>
</div>
</div>

<div id="outline-container-howto_gem5" class="outline-3">
<h3 id="howto_gem5"><span class="section-number-3">3.2</span> How to Simulate Spectre with gem5</h3>
<div class="outline-text-3" id="text-howto_gem5">
</div>
</div>

<div id="outline-container-howto_konata" class="outline-3">
<h3 id="howto_konata"><span class="section-number-3">3.3</span> How to Visualize the Pipeline of a gem5 Processor with Konata</h3>
<div class="outline-text-3" id="text-howto_konata">
</div>
</div>
</div>

<div id="outline-container-org9419b5c" class="outline-2">
<h2 id="org9419b5c"><span class="section-number-2">4</span> Implementations</h2>
<div class="outline-text-2" id="text-4">
<p>
Implementation details goes here.
</p>
</div>

<div id="outline-container-orgc29b5d5" class="outline-3">
<h3 id="orgc29b5d5"><span class="section-number-3">4.1</span> Spectre</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Our implementation resides in the <code>spectre</code> directory of the repository:
</p>

<pre class="example" id="org84fe805">
spectre
├── asm.c
├── asm.h
├── main.c
├── Makefile
├── perf.c
├── perf.h
├── spectre_pht_sa_ip.c
├── spectre_pht_sa_ip.h
├── util.c
└── util.h

0 directories, 10 files
</pre>

<p>
It is composed of the following modules:
</p>
<dl class="org-dl">
<dt><code>asm</code></dt><dd>ARM assembly implementation.</dd>
<dt><code>main</code></dt><dd>Orchestrate all the modules.</dd>
<dt><code>perf</code></dt><dd><code>perf_event</code> wrapper.</dd>
<dt><code>spectre_pht_sa_ip</code></dt><dd>Spectre implementation (for the PHT-SA-IP
version).</dd>
<dt>util</dt><dd>Useful functions used across the binary.</dd>
</dl>

<p>
Note that:
</p>
<ul class="org-ul">
<li>There is a lot of comments into the code, don't hesitate to look at it to
understands specific parts of the Spectre attack or the assembly
instructions.</li>
</ul>
</div>
</div>

<div id="outline-container-org9fd6e57" class="outline-3">
<h3 id="org9fd6e57"><span class="section-number-3">4.2</span> gem5</h3>
</div>
</div>

<div id="outline-container-org0de5527" class="outline-2">
<h2 id="org0de5527"><span class="section-number-2">5</span> Appendices</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>If you are a gem5 user who experience some unresolved errors, you could see
the <a href="https://pierreay.github.io/reproduce-spectre-gem5/gem5_errors.html"><code>docs/gem5_errors.html</code></a> file.</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Pierre Ayoub</p>
<p class="date">Created: 2021-03-31 mer. 12:41</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
