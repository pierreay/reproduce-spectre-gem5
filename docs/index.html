<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-04-12 lun. 10:02 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reproducing Spectre Attack with gem5, How To Do It Right?</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Pierre Ayoub" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="https://sandyuraz.com/styles/org.min.css">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Reproducing Spectre Attack with gem5, How To Do It Right?</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4e3467c">1. Introduction</a></li>
<li><a href="#org9026547">2. HowTo</a>
<ul>
<li><a href="#setup_arm">2.1. How to Setup the Native ARM System</a></li>
<li><a href="#howto_spectre">2.2. How to Perform the Spectre Attack</a></li>
<li><a href="#howto_gem5_setup">2.3. How to Setup gem5 for a Full-System Simulation</a></li>
<li><a href="#howto_gem5">2.4. How to Simulate Spectre with gem5</a></li>
<li><a href="#howto_konata">2.5. How to Visualize the Pipeline of a gem5 Processor with Konata</a></li>
</ul>
</li>
<li><a href="#orgfb065df">3. Implementations</a>
<ul>
<li><a href="#implem_spectre">3.1. Spectre</a></li>
<li><a href="#implem_gem5">3.2. gem5</a></li>
</ul>
</li>
<li><a href="#org680ff13">4. Appendices</a></li>
</ul>
</div>
</div>

<div id="outline-container-org4e3467c" class="outline-2">
<h2 id="org4e3467c"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Welcome to the additional web page from the "<a href="https://github.com/pierreay/reproduce-spectre-gem5/blob/main/docs/paper.pdf">Reproducing Spectre Attack with
gem5, How To Do It Right?</a>" paper published at EuroSec'21 by Pierre Ayoub and
Cl√©mentine Maurice. The "<a href="https://github.com/pierreay/reproduce-spectre-gem5/blob/main/docs/master_thesis.pdf">Simulating Transient Execution Attacks with gem5</a>"
master thesis is also an interesting document concerning the background
knowledge which is extensively described, while the results mentioned in this
document are obsolete.
</p>

<p>
This page will guide you through the reproduction of the experiments, the
usage of our implementations and through the demonstration of some techniques
discussed in the paper.
</p>

<p>
This web page is part of a <a href="https://github.com/pierreay/reproduce-spectre-gem5">GitHub repository</a>.
</p>
</div>
</div>

<div id="outline-container-org9026547" class="outline-2">
<h2 id="org9026547"><span class="section-number-2">2</span> HowTo</h2>
<div class="outline-text-2" id="text-2">
<p>
In this section, we will guide through step-by-step in the usage of our
implementations. You can jump from one HowTo to another to see what it is
about, but to make things work, you will have to follow them in the order
below (note that shell variables are shared across sections). Let's start!
</p>
</div>

<div id="outline-container-setup_arm" class="outline-3">
<h3 id="setup_arm"><span class="section-number-3">2.1</span> How to Setup the Native ARM System</h3>
<div class="outline-text-3" id="text-setup_arm">
<p>
To reproduce this work, you will need:
</p>
<ul class="org-ul">
<li>An ARM board. We used a <a href="https://static.raspberrypi.org/files/product-briefs/200521+Raspberry+Pi+4+Product+Brief.pdf">Raspberry Pi v4 Model B Rev 1.1</a> embedding a <a href="http://infocenter.arm.com/help/topic/com.arm.doc.100095_0003_06_en/cortex_a72_mpcore_trm_100095_0003_06_en.pdf">ARM
Cortex-A72</a> (ARMv8-A) processor implemented in a SoC <a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2711/rpi_DATA_2711_1p0.pdf">Broadcom BCM2711</a>.</li>
<li>A 64-bit operating system (kernel and userland) for ARM. We used <a href="https://www.offensive-security.com/kali-linux-arm-images/">Kali
Linux</a> (stable v2020.2a, with a Linux kernel v4.19.118-Re4son-v8l+ and a
GCC compiler v9.3) because:
<ol class="org-ol">
<li>It is a full 64-bit operating system supporting ARM,</li>
<li>The kernel is nearly the same as the one provided by gem5,</li>
<li>The kernel sources and headers are available with <code>apt</code> (for developing
kernel modules, if you do so).</li>
</ol></li>
</ul>

<p>
Install the Kali Linux distribution. At the time of the study, the image was
hosted on the official website and available through direct
download. Unfortunately, you'll now have to either download the last version
on the official website, download the same version as we used through a
<a href="http://itorrents.org/torrent/6E3AB22CDCD43A8DFD89B4AFA9272E6ED4BC6911.torrent?title=kali-linux-2020-2a-rpi3-nexmon-64-img-xz">torrent</a> (unofficiel) or compile it yourself. Here, we assume that you
download the image through the torrent and place the <code>.xz</code> file in the
<code>/tmp</code> directory:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> /tmp
<span style="color: #47ba99;">zip</span>=<span style="color: #fbaed2;">"kali-linux-2020.2a-rpi3-nexmon-64.img.xz"</span>
<span style="color: #47ba99;">img</span>=<span style="color: #fbaed2;">"kali-linux-2020.2a-rpi3-nexmon-64.img"</span>
xzcat <span style="color: #fbaed2;">"$zip"</span> &gt; <span style="color: #fbaed2;">"$img"</span>
rm -f <span style="color: #fbaed2;">"$zip"</span>
</pre>
</div>

<p>
Then, insert your SD card in your computer, and make sure that device block
name is correct (find it with <code>lsblk</code> and <code>umount</code> it if it has been
automatically mounted). Bit-copy the image on the SD card:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">sdcard</span>=/dev/sdX <span style="color: #697375;"># </span><span style="color: #697375;">Replace the X with your block device letter.</span>
sudo dd <span style="color: #47ba99;">bs</span>=<span style="color: #ef6787;">4M</span> <span style="color: #47ba99;">if</span>=<span style="color: #fbaed2;">"$img"</span> <span style="color: #47ba99;">of</span>=<span style="color: #fbaed2;">"$sdcard"</span> <span style="color: #47ba99;">status</span>=progress <span style="color: #47ba99;">conv</span>=fsync
</pre>
</div>

<p>
Now, plug the SD card in the Raspberry Pi, plug an Ethernet cable and plug
the power cable in it. Then, find the IP address associated to it and
connect with the <code>kali</code> login and <code>kali</code> password:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">ip</span>=<span style="color: #fbaed2;">"192.168.1.1"</span> <span style="color: #697375;"># </span><span style="color: #697375;">Find the correct IP with nmap or your router interface.</span>
ssh kali@$<span style="color: #47ba99;">ip</span>
<span style="color: #697375;"># </span><span style="color: #697375;">We used the following software:</span>
sudo apt-get update &amp;&amp; sudo apt-get upgrade
sudo apt-get -y install linux-cpupower git
</pre>
</div>

<p>
You can log in the <code>root</code> account by issuing the command <code>sudo su root</code> if
needed.
</p>

<p>
You are now ready to compile and reproduce Spectre on the Raspberry Pi.
</p>
</div>
</div>

<div id="outline-container-howto_spectre" class="outline-3">
<h3 id="howto_spectre"><span class="section-number-3">2.2</span> How to Perform the Spectre Attack</h3>
<div class="outline-text-3" id="text-howto_spectre">
<p>
We assume that you are on the ARM system described in Section <a href="#setup_arm">2.1</a> or
an equivalent one.
</p>

<p>
First, clone the repository:
</p>

<div class="org-src-container">
<pre class="src src-bash">git clone https://github.com/pierreay/reproduce-spectre-gem5
<span style="color: #697375;"># </span><span style="color: #697375;">We will use this variable to designate the repository through the hole file.</span>
<span style="color: #47ba99;">reproduce_repo</span>=<span style="color: #fbaed2;">"$(pwd)"</span>/reproduce-spectre-gem5
<span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$reproduce_repo"</span>
</pre>
</div>

<p>
Simply use the <code>Makefile</code> to compile our implementation, described in
Section <a href="#implem_spectre">3.1</a>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> spectre &amp;&amp; make
</pre>
</div>

<p>
Test if the binary is working by displaying a useful help message:
</p>

<div class="org-src-container">
<pre class="src src-bash">./spectre --help
</pre>
</div>

<pre class="example" id="org5d7effd">
Usage: spectre [OPTION...]
Spectre -- A Spectre implementation useful for research

  -c, --cache_threshold=NUMBER   Cache threshold separating hit and miss
                             (default: automatically computed)
  -l, --loops=NUMBER         Number of loops (training and attack) per attempts
                             (default: 30)
  -m, --meta=NUMBER          Number of meta-repetition of Spectre (default: 1)
  -q, -s, --quiet, --silent  Don't produce the header for csv
  -t, --tries=NUMBER         Number of attempts to guess a secret byte
                             (default: 999)
  -v, --verbose              Produce verbose output
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version

Mandatory or optional arguments to long options are also mandatory or optional
for any corresponding short options.

Report bugs to &lt;pierre.ayoub@irisa.fr&gt;.
</pre>

<p>
And test the attack with the default parameters like this:
</p>

<div class="org-src-container">
<pre class="src src-bash">./spectre 
</pre>
</div>

<p>
If it works correctly, you surely want to generate the metrics as we do in
the paper and customize some parameters. The metrics will be generated in a
<code>csv</code> format, you can then redirect them to a file. To do so, we use this
loop to repeat the hole experiment. We first launch one experiment, and
relaunch the others with the <code>-q</code> flag to suppress header line:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #697375;"># </span><span style="color: #697375;">Parameters.</span>
<span style="color: #47ba99;">runs</span>=<span style="color: #ef6787;">50</span> <span style="color: #697375;"># </span><span style="color: #697375;">Number of runs - 1.</span>
<span style="color: #47ba99;">m</span>=<span style="color: #ef6787;">10</span>    <span style="color: #697375;"># </span><span style="color: #697375;">Number of meta repetition in the binary itself.</span>
<span style="color: #47ba99;">t</span>=<span style="color: #ef6787;">999</span>   <span style="color: #697375;"># </span><span style="color: #697375;">Number of attempts to guess one byte.</span>
<span style="color: #47ba99;">l</span>=<span style="color: #ef6787;">100</span>   <span style="color: #697375;"># </span><span style="color: #697375;">Number of loop per attempt.</span>
<span style="color: #697375;"># </span><span style="color: #697375;">Runs.</span>
./spectre/spectre -m $<span style="color: #47ba99;">m</span> -l $<span style="color: #47ba99;">l</span> -t $<span style="color: #47ba99;">t</span>
<span style="color: #4EB8CA;">for</span> <span style="color: #4EB8CA;">(</span><span style="color: #91b9c7;">(</span> <span style="color: #47ba99;">i</span> = <span style="color: #ef6787;">1</span>; i &lt; $<span style="color: #47ba99;">runs</span>; i++ <span style="color: #91b9c7;">)</span><span style="color: #4EB8CA;">)</span>
<span style="color: #4EB8CA;">do</span>  
    ./spectre/spectre -q -m $<span style="color: #47ba99;">m</span> -l $<span style="color: #47ba99;">l</span> -t $<span style="color: #47ba99;">t</span>   
<span style="color: #4EB8CA;">done</span>
</pre>
</div>

<p>
<b>Optional</b>. If you want to obtain the <code>perf_event</code> metrics under a gem5
simulation, you will have to recompile the Spectre binary with a patch. To
do that, use <code>git-apply</code> to apply the patch, save the previously compiled
binary with another name and relaunch <code>make</code>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #697375;"># </span><span style="color: #697375;">Apply the patch</span>
<span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$reproduce_repo"</span>
git apply spectre/perf.c.patch
<span style="color: #697375;"># </span><span style="color: #697375;">Save the previous binary</span>
<span style="color: #91b9c7;">cd</span> spectre
mv spectre spectre_native
<span style="color: #697375;"># </span><span style="color: #697375;">Compile the new Spectre</span>
make
</pre>
</div>
</div>
</div>

<div id="outline-container-howto_gem5_setup" class="outline-3">
<h3 id="howto_gem5_setup"><span class="section-number-3">2.3</span> How to Setup gem5 for a Full-System Simulation</h3>
<div class="outline-text-3" id="text-howto_gem5_setup">
<p>
To reproduce this work, you will need:
</p>
<ul class="org-ul">
<li>A working <a href="https://www.gem5.org/getting_started/">gem5</a> installation. We used gem5 v20.0.</li>
<li>An <a href="https://www.gem5.org/documentation/general_docs/fullsystem/guest_binaries">operating system image and a kernel image</a> ready-to-use with gem5. We
used the <a href="http://dist.gem5.org/dist/current/arm/disks/linaro-minimal-aarch64.img.bz2">64-bit Linaro Minimal v7.4.0 (based on Ubuntu)</a> and the <a href="http://dist.gem5.org/dist/current/arm/aarch-system-201901106.tar.bz2">ARM64
Linux kernel v4.18.0</a> images provided by gem5's developers.</li>
</ul>

<p>
Note that this gem5 version and the images are now obsolete. You can of
course follow our steps, but then for a new research, it would be better to
use the latest gem5 version and images with the new recommended methods
(e.g., Docker container).
</p>

<p>
First, install the recommended packages:
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo apt install build-essential git m4 scons zlib1g zlib1g-dev <span style="color: #fbaed2;">\</span>
    libprotobuf-dev protobuf-compiler libprotoc-dev libgoogle-perftools-dev <span style="color: #fbaed2;">\</span>
    python3-dev python3-six python libboost-all-dev pkg-config
</pre>
</div>

<p>
Clone the gem5 repository:
</p>

<div class="org-src-container">
<pre class="src src-bash">git clone https://gem5.googlesource.com/public/gem5
<span style="color: #697375;"># </span><span style="color: #697375;">We will use this variable to designate the gem5 repository through the hole</span>
<span style="color: #697375;"># </span><span style="color: #697375;">file.</span>
<span style="color: #47ba99;">gem5_repo</span>=<span style="color: #fbaed2;">"$(pwd)"</span>/gem5
<span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$gem5_repo"</span>
</pre>
</div>

<p>
Checkout the commit for version 20.0:
</p>

<div class="org-src-container">
<pre class="src src-bash">git checkout v20.0.0.0
</pre>
</div>

<p>
<b>Optional</b>. If you want to obtain the <code>perf_event</code> metrics under a gem5
simulation, you will have to apply a patch from our repository to the gem5
source code to enable <code>perf_event</code> on the gem5 side (note that it should not
be required on the latest gem5 version). To do that, use:
</p>

<div class="org-src-container">
<pre class="src src-bash">git apply <span style="color: #fbaed2;">"$reproduce_repo"</span>/gem5/perf_event.patch
</pre>
</div>

<p>
And finally, compile it in optimized mode (<code>opt</code>), for the ARM architecture
(<code>ARM</code>), with 8 cores and for Python 3. It can take several hours:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">mode</span>=<span style="color: #fbaed2;">"opt"</span>
<span style="color: #47ba99;">arch</span>=<span style="color: #fbaed2;">"ARM"</span>
<span style="color: #47ba99;">cores</span>=<span style="color: #ef6787;">8</span>
<span style="color: #47ba99;">py_version</span>=<span style="color: #ef6787;">3</span> 
scons <span style="color: #47ba99;">PYTHON_CONFIG</span>=python$<span style="color: #47ba99;">py_version</span>-config build/$<span style="color: #47ba99;">arch</span>/gem5.$<span style="color: #47ba99;">mode</span> -j $<span style="color: #47ba99;">cores</span>
</pre>
</div>

<p>
If everything is working, you should be able to display the help of our
simulation script:
</p>

<div class="org-src-container">
<pre class="src src-bash">build/ARM/gem5.opt -q <span style="color: #fbaed2;">"$reproduce_repo"</span>/gem5/RPIv4.py --help   
</pre>
</div>

<pre class="example" id="org101390f">
usage: RPIv4.py [-h] [-v] [--num-cores NUM_CORES] [--se] [--fs]
                [--fs-kernel FS_KERNEL] [--fs-disk-image FS_DISK_IMAGE]
                [--fs-workload-image FS_WORKLOAD_IMAGE]
                [--fs-restore FS_RESTORE]
                [se-command [se-command ...]]

Raspberry Pi 4 Model B Rev. 1.1 - Syscall emulation &amp; Full-system simulation
Script based on a real Raspberry Pi system. It is shipped with a "reproduced"
ARM Cortex-A72 CPU. The intended use is security research. It can be used both
in system-call emulation or full-system simulation. For the full-system
simulation mode only, first boot your system and create a checkpoint where the
used CPU will be the atomic one. Only then, restore you system from your
checkpoint, where the CPU used will be the detailed one. When passing
filenames in arguments of the script, please be sure that your M5_PATH
environment variable is set accordingly.

positional arguments:
  se-command            Command(s) to run (multiples commands are assigned to
                        a dedicated core)

optional arguments:
  -h, --help            show this help message and exit
  -v, --verbose         Print detailed information of what is done
  --num-cores NUM_CORES
                        Number of CPU cores (default = 1)
  --se                  Enable system-call emulation (must provide 'command'
                        positional arguments)
  --fs                  Enable full-system emulation (must provide '--fs-
                        kernel' and '--fs-disk-image' options)
  --fs-kernel FS_KERNEL
                        Filename of the Linux kernel to use in full-system
                        emulation (searched under '$M5_PATH/binaries'
                        directory)
  --fs-disk-image FS_DISK_IMAGE
                        Filename of the disk image containing the system to
                        instantiate in full-system emulation
  --fs-workload-image FS_WORKLOAD_IMAGE
                        Filename of the disk image containing the workload to
                        mount in full-system emulation
  --fs-restore FS_RESTORE
                        Path to a folder created by "m5 checkpoint" command to
                        use for restoration
</pre>

<p>
Otherwise, check the <a href="https://pierreay.github.io/reproduce-spectre-gem5/gem5_errors.html#compilation"><code>docs/gem5_errors.html</code></a> file to see if the compilation
error has already been encountered.
</p>

<p>
You will also need to compile <code>m5term</code>, a tool using <code>sockets</code> to connect
to the gem5 system (<code>telnet</code> could also be used instead, but this one is
more appreciate):
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> util/term
make
</pre>
</div>

<p>
Let's create the images you need to perform a full-system
simulation. First, you have to download the operating system and the kernel
images that you will use over our simulated hardware:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$gem5_repo"</span>
<span style="color: #47ba99;">img_dir</span>=img
mkdir $<span style="color: #47ba99;">img_dir</span> &amp;&amp; <span style="color: #91b9c7;">cd</span> $<span style="color: #47ba99;">img_dir</span>
<span style="color: #697375;"># </span><span style="color: #697375;">OS</span>
wget -O - http://dist.gem5.org/dist/current/arm/disks/linaro-minimal-aarch64.img.bz2 | bunzip2 &gt; linaro-minimal-aarch64.img
<span style="color: #697375;"># </span><span style="color: #697375;">Kernel</span>
wget -O - http://dist.gem5.org/dist/current/arm/aarch-system-201901106.tar.bz2 | tar xjv
</pre>
</div>

<p>
Then, you will have to create a third <code>workload.img</code> image that will
contain the file(s) that you want to use in your experiments. In order to
do that, first create a 100MB zero file (you can change the size with the
<code>count</code> parameter):
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">img</span>=workload.img
dd <span style="color: #47ba99;">if</span>=/dev/zero <span style="color: #47ba99;">of</span>=$<span style="color: #47ba99;">img</span> <span style="color: #47ba99;">count</span>=<span style="color: #ef6787;">200K</span>
</pre>
</div>

<p>
Create a loopback device in order to access the image as a block device:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #47ba99;">dev</span>=$<span style="color: #4EB8CA;">(</span>sudo losetup -f<span style="color: #4EB8CA;">)</span>
sudo losetup -fP $<span style="color: #47ba99;">img</span>
</pre>
</div>

<p>
Create a DOS partition table and a primary partition on the entire image,
then format the new created partition with the <code>ext4</code> file system:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">echo</span> <span style="color: #fbaed2;">","</span> | sudo sfdisk $<span style="color: #47ba99;">dev</span>
sudo mke2fs <span style="color: #fbaed2;">"$dev"</span>p1
</pre>
</div>

<p>
Finally, you are done at modifying your image, detach it from the loopback
device:
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo losetup -d $<span style="color: #47ba99;">dev</span>
</pre>
</div>

<p>
Now, you have a persistent file that will hold your files for the
simulation. Define a function that will be used each time you need to
update the image with new files (binaries, data&#x2026;):
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #697375;"># </span><span style="color: #697375;">$1: workload image name/path.</span>
<span style="color: #697375;"># </span><span style="color: #697375;">$*: list of files to copy.</span>
<span style="color: #91b9c7;">workload_update</span><span style="color: #4EB8CA;">()</span> <span style="color: #4EB8CA;">{</span>
    <span style="color: #47ba99;">local_dev</span>=$<span style="color: #91b9c7;">(</span>sudo losetup -f<span style="color: #91b9c7;">)</span>
    <span style="color: #47ba99;">local_mnt</span>=/mnt/workload
    <span style="color: #697375;"># </span><span style="color: #697375;">Get arguments.</span>
    <span style="color: #47ba99;">local_img</span>=<span style="color: #fbaed2;">"$1"</span>
    <span style="color: #91b9c7;">shift</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Create the mount folder and the loop device.</span>
    sudo mkdir -p $<span style="color: #47ba99;">local_mnt</span>
    sudo losetup -fP <span style="color: #fbaed2;">"$local_img"</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Mount the block device.</span>
    sudo mount -o loop <span style="color: #fbaed2;">"$local_dev"</span>p1 $<span style="color: #47ba99;">local_mnt</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Copy files/folders.</span>
    sudo cp -r -f -t $<span style="color: #47ba99;">local_mnt</span> $<span style="color: #47ba99;">*</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">List the files to confirm.</span>
    ls -alh $<span style="color: #47ba99;">local_mnt</span>
    <span style="color: #697375;"># </span><span style="color: #697375;">Unmount the image and freed the loop device.</span>
    sudo umount $<span style="color: #47ba99;">local_mnt</span>
    sudo losetup -d $<span style="color: #47ba99;">local_dev</span>
<span style="color: #4EB8CA;">}</span>
</pre>
</div>

<p>
We will use this function later. All your 3 images will be mounted directly
in the simulated system by gem5 itself, and the files in the workload image
will be accessible in read/write. This is an efficient and handy way to
communicate with a gem5 simulation.
</p>
</div>
</div>

<div id="outline-container-howto_gem5" class="outline-3">
<h3 id="howto_gem5"><span class="section-number-3">2.4</span> How to Simulate Spectre with gem5</h3>
<div class="outline-text-3" id="text-howto_gem5">
<p>
We assume that you are able to compile and know how to perform a Spectre
attack with our binary (at least in theory), described in Section
<a href="#howto_spectre">2.2</a>.
</p>

<p>
We assume that your gem5 setup is ready to perform a full-system simulation,
described in Section <a href="#howto_gem5_setup">2.3</a>.
</p>

<p>
<b>Boot</b>. The first step is to boot the system once, which can take up to one
entire hour. You will launch the simulation of our system, described in
Section <a href="#implem_gem5">3.2</a>, with gem5. Call gem5 with our Python script describing
our system, declare 4 cores and the images for the full-system simulation
with this command:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$reproduce_repo"</span>/gem5
<span style="color: #fbaed2;">"$gem5_repo"</span>/build/ARM/gem5.opt -q -d <span style="color: #ef6787;">01boot</span> <span style="color: #fbaed2;">\</span>
                                ./RPIv4.py -v --num-cores=<span style="color: #ef6787;">4</span> --fs <span style="color: #fbaed2;">\</span>
                                --fs-kernel=<span style="color: #fbaed2;">"$gem5_repo"</span>/<span style="color: #fbaed2;">"$img_dir"</span>/binaries/vmlinux.arm64 <span style="color: #fbaed2;">\</span>
                                --fs-disk-image=<span style="color: #fbaed2;">"$gem5_repo"</span>/<span style="color: #fbaed2;">"$img_dir"</span>/linaro-minimal-aarch64.img <span style="color: #fbaed2;">\</span>
                                --fs-workload-image=<span style="color: #fbaed2;">"$gem5_repo"</span>/<span style="color: #fbaed2;">"$img_dir"</span>/<span style="color: #fbaed2;">"$img"</span>
</pre>
</div>

<p>
On another shell, launch the following command to connect to your simulation
with <code>m5term</code>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fbaed2;">"$gem5_repo"</span>/util/term/m5term localhost <span style="color: #ef6787;">3456</span>
</pre>
</div>

<p>
You must now see the boot process of the simulated system. Wait for the boot
process to finish until you get a prompt, and then, issue the following
command:
</p>

<div class="org-src-container">
<pre class="src src-bash">m5 checkpoint
</pre>
</div>

<p>
This will create a snapshot of the running system just after the boot
process in the <code>01boot/cpt.{ticknumber}</code> folder. Now, you will be able to
restore the snapshot in a matter of second each time you want to simulate an
experiment, there is no need to wait for the boot process anymore (except if
you modify some parameters of the system in the Python files).
</p>

<p>
You can terminate your simulation. Press <code>C-d</code> to disconnect from the
terminal, and use the following command to kill gem5:
</p>

<div class="org-src-container">
<pre class="src src-bash">pkill gem5
</pre>
</div>

<p>
<b>Spectre</b>. This time, you will be able to simulate the Spectre attack in a
full-system simulation. First, copy the Spectre binary on the <code>workload.img</code>
image. Use our predefined function (Section <a href="#howto_gem5_setup">2.3</a>) for that:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> <span style="color: #fbaed2;">"$reproduce_repo"</span>
workload_update <span style="color: #fbaed2;">"$gem5_repo"</span>/<span style="color: #fbaed2;">"$img_dir"</span>/<span style="color: #fbaed2;">"$img"</span> spectre/spectre
</pre>
</div>

<p>
You know have a ready <code>workload.img</code> image with the Spectre binary
inside. The last step is to relaunch the simulation from the previous
checkpoint:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fbaed2;">"$gem5_repo"</span>/build/ARM/gem5.opt -q -d <span style="color: #ef6787;">02restore</span> <span style="color: #fbaed2;">\</span>
                                   ./RPIv4.py -v --num-cores=<span style="color: #ef6787;">4</span> --fs <span style="color: #fbaed2;">\</span>
                                   --fs-kernel=<span style="color: #fbaed2;">"$gem5_repo"</span>/<span style="color: #fbaed2;">"$img_dir"</span>/binaries/vmlinux.arm64 <span style="color: #fbaed2;">\</span>
                                   --fs-disk-image=<span style="color: #fbaed2;">"$gem5_repo"</span>/<span style="color: #fbaed2;">"$img_dir"</span>/linaro-minimal-aarch64.img <span style="color: #fbaed2;">\</span>
                                   --fs-workload-image=<span style="color: #fbaed2;">"$gem5_repo"</span>/<span style="color: #fbaed2;">"$img_dir"</span>/<span style="color: #fbaed2;">"$img"</span> <span style="color: #fbaed2;">\</span>
                                   --fs-restore=<span style="color: #ef6787;">01boot/cpt.*</span>
</pre>
</div>

<p>
On another shell, you can connect to the restored simulation and wait
reaching the prompt (a matter of seconds or 1-2 minutes):
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fbaed2;">"$gem5_repo"</span>/util/term/m5term localhost <span style="color: #ef6787;">3456</span>
</pre>
</div>

<p>
Inside the <code>m5term</code> session, you can issue these two commands to access to
the Spectre binary:
</p>

<div class="org-src-container">
<pre class="src src-bash">mkdir -p workload
<span style="color: #697375;"># </span><span style="color: #697375;">/dev/vdb1 correspond to the image given with the --fs-workload option.</span>
mount /dev/vdb1 ./workload
</pre>
</div>

<p>
And finally launch the Spectre attack inside the simulated system:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #91b9c7;">cd</span> workload
./spectre -m <span style="color: #ef6787;">10</span> -l <span style="color: #ef6787;">100</span> -t <span style="color: #ef6787;">999</span>
</pre>
</div>

<p>
To extract your result from the simulation, you can either redirect them in
a file on the mounted <code>workload.img</code> image, or copy-paste the terminal.
</p>

<p>
When the Spectre attack will finish, you can terminate your
simulation. Press <code>C-d</code> to disconnect from the terminal, and use the
following command to kill gem5:
</p>

<div class="org-src-container">
<pre class="src src-bash">pkill gem5
</pre>
</div>
</div>
</div>

<div id="outline-container-howto_konata" class="outline-3">
<h3 id="howto_konata"><span class="section-number-3">2.5</span> How to Visualize the Pipeline of a gem5 Processor with Konata</h3>
<div class="outline-text-3" id="text-howto_konata">
<p>
Konata is an external program allowing to see graphically the instructions
executed in the pipeline of a simulated processor. We suggest to the reader
to read <a href="http://learning.gem5.org/tutorial/presentations/vis-o3-gem5.pdf">this guide</a> before using it. The first thing to do is to download the
pre-compiled binary from its <a href="https://github.com/shioyadan/Konata">official repository</a>:
</p>

<div class="org-src-container">
<pre class="src src-bash">mkdir konata &amp;&amp; <span style="color: #91b9c7;">cd</span> konata
<span style="color: #47ba99;">konata_dir</span>=$<span style="color: #4EB8CA;">(</span><span style="color: #91b9c7;">pwd</span><span style="color: #4EB8CA;">)</span>/konata-linux-x64
wget -O - <span style="color: #fbaed2;">'https://github.com/shioyadan/Konata/releases/download/v0.34/konata-linux-x64.tar.gz'</span> | tar -xz
</pre>
</div>

<p>
In order to visualize the pipeline, you'll have to:
</p>
<ol class="org-ol">
<li>Find which part of the simulation you want to see (otherwise the generated data will be too large),</li>
<li>Run this part of the simulation with specific flags,</li>
<li>Open the generated data in Konata.</li>
</ol>

<p>
Firstly, to determine which portion of the simulation you want to see with
Konata, you'll have to run the simulation once without any special flag and
stop it (with <code>C-c</code>) at the time where the interesting part is starting. For
example, in our experiment, the interesting part is the core of the Spectre
attack. A possibility is to put a <code>printf</code> in your code just before this
part and stop the simulation when you see the output text.
</p>

<p>
When stopping the simulation, you will see a message like this one:
</p>

<pre class="example" id="org8f4ebd2">
Exiting @ tick 3266927000 because user interrupt received
</pre>

<p>
Here, 3266927000 is the number of tick we want to start the monitoring of
executed instruction. We will refer to it as <code class="src src-bash">$<span style="color: #47ba99;">ticknumber</span></code>.
</p>

<p>
Then, you'll have to run a simulation with the <code>--debug-flags=O3PipeView
   --debug-file=pipeview.txt</code> flags passed to the gem5 binary and the
<code>--debug-start=$ticknumber</code> set accordingly to the previous step:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fbaed2;">"$gem5_repo"</span>/build/ARM/gem5.opt -q <span style="color: #fbaed2;">\</span>
            --debug-flags=O3PipeView --debug-file=pipeview.txt --debug-start=$<span style="color: #47ba99;">ticknumber</span> <span style="color: #fbaed2;">\</span>
            <span style="color: #fbaed2;">"$reproduce_repo"</span>/gem5/RPIv4.py -v --se
            <span style="color: #fbaed2;">"$reproduce_repo/spectre/spectre -l 100"</span>
</pre>
</div>

<p>
When the simulation is over (or when you stopped it because it past the last
point of interest), you just have to launch the graphical interface of
Konata by issuing the <code class="src src-bash"><span style="color: #fbaed2;">"$konata_dir/konata"</span></code> command, click on <code>File</code> and search for the
<code>pipeview.txt</code> file generated with gem5 in the simulation folder.
</p>

<p>
Then, you will see a lot of instructions. How to understand and find an
interesting part in the visualization? There is two main methods:
</p>
<ul class="org-ul">
<li>Find regular pattern and match them with the loops in the C code,</li>
<li>Find the addresses of the instructions in the found patterns and match
them with the instructions in the assembly code.</li>
</ul>

<p>
<b>Demonstration</b>. Let's visualize the pipeline during the Spectre attack. We
generated a trace of a Spectre execution with the commands above, except
that we used the implementation by the <a href="https://github.com/IAIK/transientfail">IAIK team</a>
(<code>pocs/spectre/PHT/sa_ip/poc_arm</code>). We provide the needed trace in the
<code>docs/data/konata</code> directory of the repository, we encourage you to follow
our step-by-step guide at the same time.
</p>

<p>
Launch Konata with the <code>$konata_dir/konata</code> binary and open the
<code>pipeview.txt</code> file from the <code>pipeview.txt.tar.bz2</code> archive. The first thing
to do after loading the trace file is to enable <code>Hide flushed instruction</code>
in the Konata menu, otherwise, you won't be able to see any pattern but only
a linear stream (which is the goal of speculative execution) due to a lot of
flushed instruction. Then, un-zoom to identify patterns. Below the C code of
the main loop of the binary:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Main loop of Spectre, which iterate over every byte in the secret string (C code).</label><pre class="src src-c" id="orgdff27f3"><span style="color: #4EB8CA;">while</span> <span style="color: #4EB8CA;">(</span><span style="color: #ef6787;">1</span><span style="color: #4EB8CA;">)</span> <span style="color: #4EB8CA;">{</span>
    <span style="color: #697375;">// </span><span style="color: #697375;">for every byte in the string</span>
    j = <span style="color: #91b9c7;">(</span>j + <span style="color: #ef6787;">1</span><span style="color: #91b9c7;">)</span> % <span style="color: #4EB8CA;">sizeof</span><span style="color: #91b9c7;">(</span>DATA_SECRET<span style="color: #91b9c7;">)</span>;

    <span style="color: #697375;">// </span><span style="color: #697375;">mistrain with valid index</span>
    <span style="color: #4EB8CA;">for</span><span style="color: #91b9c7;">(</span><span style="color: #b9c791;">int</span> <span style="color: #47ba99;">y</span> = <span style="color: #ef6787;">0</span>; y &lt; <span style="color: #ef6787;">10</span>; y++<span style="color: #91b9c7;">)</span> <span style="color: #91b9c7;">{</span>
        access_array<span style="color: #4FA8A3;">(</span><span style="color: #ef6787;">0</span><span style="color: #4FA8A3;">)</span>;
    <span style="color: #91b9c7;">}</span>
    <span style="color: #697375;">// </span><span style="color: #697375;">potential out-of-bounds access</span>
    access_array<span style="color: #91b9c7;">(</span>j<span style="color: #91b9c7;">)</span>;

    <span style="color: #697375;">// </span><span style="color: #697375;">only show inaccessible values (SECRET)</span>
    <span style="color: #4EB8CA;">if</span><span style="color: #91b9c7;">(</span>j &gt;= <span style="color: #4EB8CA;">sizeof</span><span style="color: #4FA8A3;">(</span>DATA<span style="color: #4FA8A3;">)</span> - <span style="color: #ef6787;">1</span><span style="color: #91b9c7;">)</span> <span style="color: #91b9c7;">{</span>
        mfence<span style="color: #4FA8A3;">()</span>; <span style="color: #697375;">// </span><span style="color: #697375;">avoid speculation</span>
        <span style="color: #697375;">// </span><span style="color: #697375;">Recover data from covert channel</span>
        cache_decode_pretty<span style="color: #4FA8A3;">(</span>leaked, j<span style="color: #4FA8A3;">)</span>;
    <span style="color: #91b9c7;">}</span>
 <span style="color: #4EB8CA;">}</span>
</pre>
</div>

<p>
In the picture below, you can see one main loop iteration of the attack
which iterate over each byte to guess. The first bold blank line, top left,
is the end of the first iteration, while the second, bottom right, is the
end of the second iteration.
</p>


<div id="org63cbd5e" class="figure">
<p><img src="img/konata/konata_main_loop.png" alt="konata_main_loop.png" />
</p>
<p><span class="figure-number">Figure 1: </span>One main loop iteration.</p>
</div>

<p>
If you zoom-in on the bold line at the bottom right of the screenshot
(discussed above), you can see this: it's the end of the <code class="src src-c"><span style="color: #91b9c7;">cache_decode_pretty</span><span style="color: #4EB8CA;">()</span></code> C function &#x2013; the receiver part of the
covert-channel &#x2013;, where there is a 100 times loop over a <code>volatile</code>
variable to add a delay. To deduce yourself this information, you can count
the number of iterations (when it's small enough) or look at the addresses
of the instructions (which we do not provide here) by zooming a bit more.
</p>


<div id="org2c8406e" class="figure">
<p><img src="img/konata/konata_cache_decode_pretty.png" alt="konata_cache_decode_pretty.png" />
</p>
<p><span class="figure-number">Figure 2: </span>Loop over a variable to add a delay.</p>
</div>

<p>
Now that you have identified the main patterns by knowing when an attack's
iteration begin and finish, you can try to look directly for an address, in
order to find a transient execution. Below is the code of the conditional
branch that Spectre attacks, you see on the assembly code that its address
is <code>0x00400e74</code> corresponding to the <code class="src src-asm"><span style="color: #91b9c7;">b</span>.pl <span style="color: #ef6787;">0x400e88</span></code> instruction.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Core of the Spectre attack, with a function which access an array and check for its index with a conditional branch (C and assembly code).</label><pre class="src src-c"><span style="color: #b9c791;">char</span> <span style="color: #91b9c7;">access_array</span><span style="color: #4EB8CA;">(</span><span style="color: #b9c791;">int</span> <span style="color: #47ba99;">x</span><span style="color: #4EB8CA;">)</span> <span style="color: #4EB8CA;">{</span>
    <span style="color: #697375;">// </span><span style="color: #697375;">flushing the data which is used in the condition increases</span>
    <span style="color: #697375;">// </span><span style="color: #697375;">probability of speculation</span>
    <span style="color: #b9c791;">size_t</span> <span style="color: #47ba99;">len</span> = <span style="color: #4EB8CA;">sizeof</span><span style="color: #91b9c7;">(</span>DATA<span style="color: #91b9c7;">)</span> - <span style="color: #ef6787;">1</span>;
    mfence<span style="color: #91b9c7;">()</span>;
    flush<span style="color: #91b9c7;">(</span>&amp;len<span style="color: #91b9c7;">)</span>;
    flush<span style="color: #91b9c7;">(</span>&amp;x<span style="color: #91b9c7;">)</span>;

    <span style="color: #697375;">// </span><span style="color: #697375;">ensure data is flushed at this point</span>
    mfence<span style="color: #91b9c7;">()</span>;

    <span style="color: #697375;">// </span><span style="color: #697375;">check that only accessible part (DATA) can be accessed</span>
    <span style="color: #4EB8CA;">if</span><span style="color: #91b9c7;">(</span><span style="color: #4FA8A3;">(</span><span style="color: #b9c791;">float</span><span style="color: #4FA8A3;">)</span>x / <span style="color: #4FA8A3;">(</span><span style="color: #b9c791;">float</span><span style="color: #4FA8A3;">)</span>len &lt; <span style="color: #ef6787;">1</span><span style="color: #91b9c7;">)</span> <span style="color: #91b9c7;">{</span>
        <span style="color: #697375;">// </span><span style="color: #697375;">countermeasure: add the fence here</span>
        <span style="color: #697375;">// </span><span style="color: #697375;">Encode in cache</span>
        cache_encode<span style="color: #4FA8A3;">(</span>data<span style="color: #c791aa;">[</span>x<span style="color: #c791aa;">]</span><span style="color: #4FA8A3;">)</span>;
    <span style="color: #91b9c7;">}</span>
<span style="color: #4EB8CA;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #91b9c7;">&#9581;</span> <span style="color: #ef6787;">100</span>: sym.access_array <span style="color: #4EB8CA;">(</span>int64_t arg1, int64_t arg_1ch, int64_t arg_28h<span style="color: #4EB8CA;">)</span><span style="color: #697375;">;</span>
&#9474;           <span style="color: #697375;">; </span><span style="color: #697375;">arg int64_t arg_1ch @ sp+0x1c</span>
&#9474;           <span style="color: #697375;">; </span><span style="color: #697375;">arg int64_t arg_28h @ sp+0x28</span>
&#9474;           <span style="color: #697375;">; </span><span style="color: #697375;">arg int64_t arg1 @ x0</span>
&#9474;           <span style="color: #ef6787;">0x00400e2c</span>      fd7bbda9       stp x29, x30, <span style="color: #4EB8CA;">[</span>sp, -0x30<span style="color: #4EB8CA;">]</span>!   <span style="color: #697375;">; </span><span style="color: #697375;">sp=0xffffffffffffffd0</span>
&#9474;           <span style="color: #ef6787;">0x00400e30</span>      fd030091       mov x29, sp                 <span style="color: #697375;">; </span><span style="color: #697375;">x29=0xffffffffffffffd0</span>
&#9474;           <span style="color: #ef6787;">0x00400e34</span>      e01f00b9       str w0, <span style="color: #4EB8CA;">[</span>sp + arg_1ch<span style="color: #4EB8CA;">]</span>      <span style="color: #697375;">; </span><span style="color: #697375;">arg1</span>
&#9474;           <span style="color: #ef6787;">0x00400e38</span>      a00080d2       movz x0, <span style="color: #ef6787;">0x5</span>                <span style="color: #697375;">; </span><span style="color: #697375;">x0=0x5</span>
&#9474;           <span style="color: #ef6787;">0x00400e3c</span>      e01700f9       str x0, <span style="color: #4EB8CA;">[</span>sp + arg_28h<span style="color: #4EB8CA;">]</span>
&#9474;           <span style="color: #ef6787;">0x00400e40</span>      <span style="color: #ef6787;">9f3b03d5</span>       dsb ish
&#9474;           <span style="color: #ef6787;">0x00400e44</span>      e0a30091       add x0, sp, <span style="color: #ef6787;">0x28</span>            <span style="color: #697375;">; </span><span style="color: #697375;">x0=0xfffffffffffffff8</span>
&#9474;           <span style="color: #ef6787;">0x00400e48</span>      c2feff97       bl sym.flush                <span style="color: #697375;">;</span><span style="color: #697375;">[1] ; lr=0x400e4c -&gt; 0x910073e0 ; pc=0x400950 -&gt; 0xd50b7e20</span>
&#9474;           <span style="color: #ef6787;">0x00400e4c</span>      e0730091       add x0, sp, <span style="color: #ef6787;">0x1c</span>            <span style="color: #697375;">; </span><span style="color: #697375;">x0=0xffffffffffffffec</span>
&#9474;           <span style="color: #ef6787;">0x00400e50</span>      c0feff97       bl sym.flush                <span style="color: #697375;">;</span><span style="color: #697375;">[1] ; lr=0x400e54 -&gt; 0xd5033b9f ; pc=0x400950 -&gt; 0xd50b7e20</span>
&#9474;           <span style="color: #ef6787;">0x00400e54</span>      <span style="color: #ef6787;">9f3b03d5</span>       dsb ish
&#9474;           <span style="color: #ef6787;">0x00400e58</span>      e11f40b9       ldr w1, <span style="color: #4EB8CA;">[</span>sp, <span style="color: #ef6787;">0x1c</span><span style="color: #4EB8CA;">]</span>          <span style="color: #697375;">; </span><span style="color: #697375;">[0x1c:4]=-1 ; 28 ; tmp=0xffffffffffffffec ; w1=0xffffffff</span>
&#9474;           <span style="color: #ef6787;">0x00400e5c</span>      e01740f9       ldr x0, <span style="color: #4EB8CA;">[</span>sp, <span style="color: #ef6787;">0x28</span><span style="color: #4EB8CA;">]</span>          <span style="color: #697375;">; </span><span style="color: #697375;">sym.thread_arena</span>
&#9474;                                                                      <span style="color: #697375;">; </span><span style="color: #697375;">[0x28:4]=-1 ; tmp=0xfffffffffffffff8 ; x0=0xffffffffffffffff</span>
&#9474;           <span style="color: #ef6787;">0x00400e60</span>      <span style="color: #ef6787;">2000221e</span>       scvtf s0, w1
&#9474;           <span style="color: #ef6787;">0x00400e64</span>      <span style="color: #ef6787;">0100239e</span>       ucvtf s1, x0
&#9474;           <span style="color: #ef6787;">0x00400e68</span>      <span style="color: #ef6787;">0018211e</span>       fdiv s0, s0, s1             <span style="color: #697375;">; </span><span style="color: #697375;">s0=0x1</span>
&#9474;           <span style="color: #ef6787;">0x00400e6c</span>      <span style="color: #ef6787;">01102e1e</span>       fmov s1, <span style="color: #ef6787;">1</span>
&#9474;           <span style="color: #ef6787;">0x00400e70</span>      <span style="color: #ef6787;">1020211e</span>       fcmpe s0, s1
&#9474;       &#9581;&#9472;&lt; <span style="color: #ef6787;">0x00400e74</span>      a5000054       b.pl <span style="color: #ef6787;">0x400e88</span>               <span style="color: #697375;">; </span><span style="color: #697375;">pc=0x400e88 -&gt; 0xa8c37bfd ; likely</span>
&#9474;       &#9474;   <span style="color: #ef6787;">0x00400e78</span>      <span style="color: #ef6787;">200400d0</span>       adrp x0, <span style="color: #ef6787;">0x486000</span>           <span style="color: #697375;">; </span><span style="color: #697375;">x0=0x486000</span>
&#9474;       &#9474;   <span style="color: #ef6787;">0x00400e7c</span>      <span style="color: #ef6787;">00cc47f9</span>       ldr x0, <span style="color: #4EB8CA;">[</span>x0, <span style="color: #ef6787;">0xf98</span><span style="color: #4EB8CA;">]</span>         <span style="color: #697375;">; </span><span style="color: #697375;">[0xf98:4]=-1 ; 3992 ; tmp=0x486f98 ; x0=0x489a08 obj.data_1</span>
&#9474;       &#9474;   <span style="color: #ef6787;">0x00400e80</span>      <span style="color: #ef6787;">00c86138</span>       ldrb w0, <span style="color: #4EB8CA;">[</span>x0, w1, sxtw<span style="color: #4EB8CA;">]</span>     <span style="color: #697375;">; </span><span style="color: #697375;">w0=0xff</span>
&#9474;       &#9474;   <span style="color: #ef6787;">0x00400e84</span>      <span style="color: #ef6787;">56ffff97</span>       bl sym.cache_encode         <span style="color: #697375;">;</span><span style="color: #697375;">[2] ; lr=0x400e88 -&gt; 0xa8c37bfd ; pc=0x400bdc -&gt; 0x90000441 ; sym.cache_encode(0xff, 0xffffffff)</span>
&#9474;       &#9474;   <span style="color: #697375;">; </span><span style="color: #697375;">CODE XREF from sym.access_array @ 0x400e74</span>
&#9474;       &#9584;&#9472;&gt; <span style="color: #ef6787;">0x00400e88</span>      fd7bc3a8       ldp x29, x30, <span style="color: #4EB8CA;">[</span>sp<span style="color: #4EB8CA;">]</span>, <span style="color: #ef6787;">0x30</span>    <span style="color: #697375;">; </span><span style="color: #697375;">x29=0xffffffffffffffff ; x30=0xffffffffffffffff</span>
<span style="color: #91b9c7;">&#9584;</span>           <span style="color: #ef6787;">0x00400e8c</span>      c0035fd6       ret                         <span style="color: #697375;">; </span><span style="color: #697375;">pc=0xffffffffffffffff</span>
</pre>
</div>

<p>
This time, you want to re-enable <code>Hide flushed instruction</code> from the menu,
otherwise you will not see the transient execution. To find the address,
graphically return at the beginning of the trace and zoom-in until seeing
the instructions addresses at the left. Then, press <code>F1</code>, type "<code>f
   0x00400e74</code>", press <code>Enter</code> once to search for the address <code>0x00400e74</code> from
the beginning, and press <code>F3</code> again until finding a transient execution. An
instruction has been executed transiently when it is shadowed. After hitting
<code>F3</code> many dozens of time, you must see this at line 12781:
</p>


<div id="org86de9d4" class="figure">
<p><img src="img/konata/konata_check_bound_with_transient_exec.png" alt="konata_check_bound_with_transient_exec.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Bound check followed by a transient execution with the malicious index.</p>
</div>

<p>
In Spectre's source code, we know that the function <code class="src src-c"><span style="color: #91b9c7;">memaccess</span><span style="color: #4EB8CA;">()</span></code> is used inside the <code class="src src-c"><span style="color: #91b9c7;">cache_encode</span><span style="color: #4EB8CA;">()</span></code> function, that means that it is used when the
malicious transient load happened. Below the source code of this function
and the corresponding assembly code:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Function that load a value pointed by <code>*p</code> (C and assembly code).</label><pre class="src src-c"><span style="color: #b9c791;">void</span> <span style="color: #91b9c7;">maccess</span><span style="color: #4EB8CA;">(</span><span style="color: #b9c791;">void</span> *<span style="color: #47ba99;">p</span><span style="color: #4EB8CA;">)</span> <span style="color: #4EB8CA;">{</span>
    <span style="color: #4EB8CA;">volatile</span> <span style="color: #b9c791;">uint32_t</span> <span style="color: #47ba99;">value</span>;
    <span style="color: #4EB8CA;">asm</span> <span style="color: #4EB8CA;">volatile</span><span style="color: #91b9c7;">(</span><span style="color: #fbaed2;">"LDR %0, [%1]\n\t"</span> : <span style="color: #fbaed2;">"=r"</span><span style="color: #4FA8A3;">(</span>value<span style="color: #4FA8A3;">)</span> : <span style="color: #fbaed2;">"r"</span><span style="color: #4FA8A3;">(</span>p<span style="color: #4FA8A3;">)</span><span style="color: #91b9c7;">)</span>;
    <span style="color: #4EB8CA;">asm</span> <span style="color: #4EB8CA;">volatile</span><span style="color: #91b9c7;">(</span><span style="color: #fbaed2;">"DSB ISH"</span><span style="color: #91b9c7;">)</span>;
    <span style="color: #4EB8CA;">asm</span> <span style="color: #4EB8CA;">volatile</span><span style="color: #91b9c7;">(</span><span style="color: #fbaed2;">"ISB"</span><span style="color: #91b9c7;">)</span>;
<span style="color: #4EB8CA;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #91b9c7;">&#9581;</span> <span style="color: #ef6787;">28</span>: sym.maccess <span style="color: #4EB8CA;">(</span>int64_t arg1<span style="color: #4EB8CA;">)</span><span style="color: #697375;">;</span>
&#9474; <span style="color: #697375;">; </span><span style="color: #697375;">var int64_t var_4h @ sp+0xc</span>
&#9474; <span style="color: #697375;">; </span><span style="color: #697375;">arg int64_t arg1 @ x0</span>
&#9474; <span style="color: #ef6787;">0x00400960</span>      ff4300d1       sub sp, sp, <span style="color: #ef6787;">0x10</span>     
&#9474; <span style="color: #ef6787;">0x00400964</span>      <span style="color: #ef6787;">000040f9</span>       ldr x0, <span style="color: #4EB8CA;">[</span>x0<span style="color: #4EB8CA;">]</span>         
&#9474; <span style="color: #ef6787;">0x00400968</span>      e00f00b9       str w0, <span style="color: #4EB8CA;">[</span>sp + var_4h<span style="color: #4EB8CA;">]</span>
&#9474; <span style="color: #ef6787;">0x0040096c</span>      <span style="color: #ef6787;">9f3b03d5</span>       dsb ish              
&#9474; <span style="color: #ef6787;">0x00400970</span>      df3f03d5       isb                  
&#9474; <span style="color: #ef6787;">0x00400974</span>      ff430091       add sp, sp, <span style="color: #ef6787;">0x10</span>     
<span style="color: #91b9c7;">&#9584;</span> <span style="color: #ef6787;">0x00400978</span>      c0035fd6       ret                  
</pre>
</div>

<p>
If you zoom-in a bit, you will be able to see every execution stage for each
instruction at a certain time. The first <code>ret</code> at address <code>0x40095c</code> is the
return of the <code class="src src-c"><span style="color: #91b9c7;">flush</span><span style="color: #4EB8CA;">()</span></code> C function into the
<code class="src src-c"><span style="color: #91b9c7;">access_array</span><span style="color: #4EB8CA;">()</span></code> function. You can see how
long was the instruction at the searched address (with the <code class="src src-asm"><span style="color: #91b9c7;">b</span>.pl <span style="color: #ef6787;">0x400e88</span></code> mnemonic) to be executed due to the
condition which was long to resolve, more than the others. This is
graphically represented by an instruction which takes more space on the
horizontal axis. The speculative execution happened just after it. The
transient read you are interested in is the <code class="src src-asm"><span style="color: #91b9c7;">ldr</span> <span style="color: #4EB8CA;">x0</span>, <span style="color: #4EB8CA;">[</span>x0<span style="color: #4EB8CA;">]</span></code> at address <code>Ox400964</code> (in the <code class="src src-c"><span style="color: #91b9c7;">maccess</span><span style="color: #4EB8CA;">()</span></code> function), which is completed but never committed, and leak
the secret value in the micro-architectural domain. You can see that this
was the last transiently executed instruction in this block, if the bound
check would have been 10 cycles shorter, then the attack would have failed!
</p>


<div id="org5055df7" class="figure">
<p><img src="img/konata/konata_check_bound_with_transient_exec_detailed.png" alt="konata_check_bound_with_transient_exec_detailed.png" />
</p>
<p><span class="figure-number">Figure 4: </span>Transient execution of a read instruction with a malicious index.</p>
</div>

<p>
If you search over all the pipeline trace, you will not see another
transient execution of this load with a malicious index. That means that
despite all the iterations, the branch predictor defeated the Spectre attack
for the following iterations, which explains the bad results we had with
this implementation. You could search for when this happened by looking at
the assembly code of the main loop (C code already given <a href="#orgdff27f3">here</a>):
</p>


<div id="orgc12fd66" class="figure">
<p><img src="img/konata/spectre_asm_core_loop.png" alt="spectre_asm_core_loop.png" />
</p>
<p><span class="figure-number">Figure 5: </span>Main loop of Spectre, which iterate over every byte in the secret string (Assembly code).</p>
</div>

<p>
Search for the address <code>0x004006ac</code> of the <code class="src src-asm"><span style="color: #91b9c7;">bl</span> <span style="color: #4EB8CA;">sym.cache</span>_decode_pretty</code> instruction, from the beginning, without
<code>Hide flushed ops</code> enabled. At some point, you will arrive here:
</p>


<div id="org8e479fe" class="figure">
<p><img src="img/konata/konata_check_bound_defeat.png" alt="konata_check_bound_defeat.png" />
</p>
<p><span class="figure-number">Figure 6: </span>Spectre defeated by the branch predictor.</p>
</div>

<p>
You see the branch predictor defeating Spectre by predicting that the branch
in <code class="src src-c"><span style="color: #91b9c7;">access_array</span><span style="color: #4EB8CA;">()</span></code> will not be taken, and
thus, directly executing the code after the branch at address
<code>0x00400e88</code>. Since it is predicted not taken while it is in reality not
taken because it's the attack, the branch predictor was not tricked by
Spectre. Then the code enter the <code class="src src-c"><span style="color: #91b9c7;">cache_decode_pretty</span><span style="color: #4EB8CA;">()</span></code> function at the searched address to read the
cached letters &#x2013; and the function will only find the bytes used in the
training phase, no leaked bytes.
</p>

<p>
Finally, we show here an iteration where the branch predictor is trained by
Spectre, by taken the branch with a valid index.
</p>


<div id="org754239d" class="figure">
<p><img src="img/konata/konata_check_bound_train.png" alt="konata_check_bound_train.png" />
</p>
<p><span class="figure-number">Figure 7: </span>Branch predictor being trained.</p>
</div>

<p>
In summary, you were able to see the three scenarios:
</p>
<ol class="org-ol">
<li>When Spectre succeed and retrieve a byte,</li>
<li>When Spectre is defeated and failed &#x2013; which has been helpful during our
research,</li>
<li>When Spectre trains the branch predictor before the attack.</li>
</ol>

<p>
Note that gem5 is able to output a large number of information from every
element of the system. For instance, during our work, we used to trace
instruction execution, which output the state of the processor along with
the executed instruction, by using the "<code class="src src-bash">--debug-flags=O3CPU,Exec</code>" flag for the gem5 binary. We also used the
<code>"$gem5_repo"/util/tracediff</code> binary, which allows to navigate in a <code>diff</code>
view of the instructions executed between two simulation with different
parameters, with this command:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fbaed2;">"$gem5_repo"</span>/util/tracediff <span style="color: #fbaed2;">\</span>
            <span style="color: #fbaed2;">"$gem5_repo"</span>/build/ARM/gem5.opt -q --debug-flags=Exec,-ExecSymbol <span style="color: #fbaed2;">\</span>
            <span style="color: #fbaed2;">"$gem5_repo"</span>/configs/example/arm/starter_se.py <span style="color: #fbaed2;">\</span>
            <span style="color: #fbaed2;">"\"$reproduce_repo/spectre/spectre -l 100\"|\"$reproduce_repo/spectre/spectre -l 50\""</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfb065df" class="outline-2">
<h2 id="orgfb065df"><span class="section-number-2">3</span> Implementations</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-implem_spectre" class="outline-3">
<h3 id="implem_spectre"><span class="section-number-3">3.1</span> Spectre</h3>
<div class="outline-text-3" id="text-implem_spectre">
<p>
Our implementation lives in the <code>spectre</code> directory of the repository:
</p>

<pre class="example" id="org23528b4">
spectre
‚îú‚îÄ‚îÄ asm.c
‚îú‚îÄ‚îÄ asm.h
‚îú‚îÄ‚îÄ main.c
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ perf.c
‚îú‚îÄ‚îÄ perf.c.patch
‚îú‚îÄ‚îÄ perf.h
‚îú‚îÄ‚îÄ spectre_pht_sa_ip.c
‚îú‚îÄ‚îÄ spectre_pht_sa_ip.h
‚îú‚îÄ‚îÄ util.c
‚îî‚îÄ‚îÄ util.h

0 directories, 11 files
</pre>

<p>
It is composed of the following modules:
</p>
<dl class="org-dl">
<dt><code>asm</code></dt><dd>ARM assembly implementation. Directly inside the files, we
described in details the use of the <code class="src src-asm"><span style="color: #91b9c7;">dsb</span></code>, <code class="src src-asm"><span style="color: #91b9c7;">isb</span></code> and <code class="src src-asm"><span style="color: #91b9c7;">dc</span> <span style="color: #4EB8CA;">civac</span></code> instructions in order to implement the
<code class="src src-c"><span style="color: #91b9c7;">mfence</span><span style="color: #4EB8CA;">()</span></code>, <code class="src src-c"><span style="color: #91b9c7;">ifence</span><span style="color: #4EB8CA;">()</span></code>, <code class="src src-c"><span style="color: #91b9c7;">flush</span><span style="color: #4EB8CA;">()</span></code>, <code class="src src-c"><span style="color: #91b9c7;">rdtsc</span><span style="color: #4EB8CA;">()</span></code> functions as well as an anti-speculation, a
memory access function and Flush+Reload functions.</dd>
<dt><code>main</code></dt><dd>Orchestrate all the modules. Handles the arguments, the
meta-repetition of the attack, the memory allocations, and the metrics
reporting.</dd>
<dt><code>perf</code></dt><dd><code>perf_event</code> wrapper. It builds convenient functions to
initialize <code>perf_event</code> and read the counters on top of the Linux system
calls.</dd>
<dt><code>spectre_pht_sa_ip</code></dt><dd>Spectre implementation (for the PHT-SA-IP
version). Implements the covert-channel, the training and the attack
phase, as well as the simple heuristic to determine if the guess is
correct.</dd>
<dt><code>util</code></dt><dd>Utilities functions used across the binary. Implements the
argument handling, cache-hit threshold detector, gem5's related function,
hamming distance and others useful functions.</dd>
</dl>

<p>
The utility of the patch is discussed in Section <a href="#howto_spectre">2.2</a>. Its purpose
is only to comment/uncomment a few lines to switch from a working
<code>perf_event</code> on a native ARM system to a working <code>perf_event</code> on a gem5 ARM
system (this is still a TODO item in the code). Note that there is a lot of
comments into the code to explain everything, don't hesitate to look at it
to understand specific parts of the Spectre attack, the assembly
instructions, or the choices that have been made.
</p>
</div>
</div>

<div id="outline-container-implem_gem5" class="outline-3">
<h3 id="implem_gem5"><span class="section-number-3">3.2</span> gem5</h3>
<div class="outline-text-3" id="text-implem_gem5">
<p>
Our gem5 system lives in the <code>gem5</code> directory of the repository:
</p>

<pre class="example">
gem5
‚îú‚îÄ‚îÄ ARMv8A_Cortex_A72.py
‚îú‚îÄ‚îÄ perf_event.patch
‚îî‚îÄ‚îÄ RPIv4.py

0 directories, 3 files
</pre>


<p>
It is composed of the following modules:
</p>
<dl class="org-dl">
<dt><code>ARMv8A_Cortex_A72</code></dt><dd>Cluster and cores classes based on the ARM Cortex
A72 processor. This file defines the classes of a lot of important
components, like the branch predictor, the walker cache, the L1/L2 caches,
the cores and the processor itself, the pipeline configuration, and the
connections between all these components. Note that modeling a processor
is a very complex and long task, thus this model is surely not suitable to
use for a high-fidelity performance evaluation, rather it is suitable to
be used for security research.</dd>
<dt><code>RPIv4</code></dt><dd>System class based on a Raspberry Pi 4 Model B. This file
defines the classes of the main memory, the system itself (RealView
platform), tied-up every component and implements the functions that
interface gem5 and the host operating system (disks, arguments, PMU). In
this file, a lot of instantiation of objects that lack documentation in
gem5 are explained in the comments, feel free to refer to it if you want
to know how a full-system simulation works and how to implement it in a
"convenient way".</dd>
</dl>

<p>
The "convenient way" we talked about in the last paragraph corresponds to:
</p>
<dl class="org-dl">
<dt>The boot process</dt><dd>The first boot is done with a simple and fast processor
model (an <code>AtomicSimpleCPU</code>), which allows to boot the system in less that
one hour. When a restoration is done, it is automatically detected and
replace the simple and fast processor model by a detailed and slow one (a
derived <code>O3CPU</code>).</dd>
<dt>The workload share</dt><dd>Several methods exists to share files between the host
system and the gem5 system, as modifying the large operating system image
or piping through the terminal. Our choice was to create a new block
device on the gem5 system and to use a dedicated so-called "workload"
image, allowing to use an unmodified system image, to swap them, and to be
less error prone than terminal piping.</dd>
<dt>The simulation mode</dt><dd>Regarding the goal of an experiment, it can be useful
to use the system-call emulation (fast) or the full-system simulation
(realistic) with the same simulated hardware (system and processor
models). Thus, our system support the both modes with the same Python
file, unlike the majority of scripts provided with gem5.</dd>
</dl>

<p>
The utility of the patch is discussed in Section <a href="#howto_gem5_setup">2.3</a>. Briefly,
it generates the PMU declaration in the device tree to enable communication
between the Linux kernel and the gem5 PMU model. To deeply understand what
the patch does and how it works, see our corresponding <a href="https://stackoverflow.com/questions/63988672/using-perf-event-with-the-arm-pmu-inside-gem5">StackOverflow post</a> or
our <a href="https://www.mail-archive.com/gem5-users@gem5.org/msg18401.html">ticket on the gem5 mailing list</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org680ff13" class="outline-2">
<h2 id="org680ff13"><span class="section-number-2">4</span> Appendices</h2>
<div class="outline-text-2" id="text-4">
<p>
If you are a gem5 user who experience some unresolved errors, you could check
the <a href="https://pierreay.github.io/reproduce-spectre-gem5/gem5_errors.html#runtime"><code>docs/gem5_errors.html</code></a> file of the repository.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Pierre Ayoub</p>
<p class="date">Created: 2021-04-12 lun. 10:02</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
